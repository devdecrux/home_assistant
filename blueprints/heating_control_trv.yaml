blueprint:
  name: Aqara TRV â€“ External Sensor (Compact Comfort & Eco Schedule, v10.3 BETA)
  description: >
    Controls an Aqara TRV using an external temperature sensor with comfort and eco modes,
    based on Home Assistant Schedule helpers.

    ðŸ§© Features:
    - External sensor temperature control
    - Internal TRV fallback when sensor unavailable
    - Radiator heat compensation (offset)
    - Comfort / Eco temperature modes with configurable hysteresis
    - HA Schedule-based switching (to-the-second accuracy)
    - Cross-midnight handled by HA Schedule entities
    - Smart logging, idempotent updates, and startup sync
    - TRV modes: heat / off only

  domain: automation

  input:
    aqara_trv:
      name: Aqara TRV
      description: The TRV climate entity to control.
      selector:
        entity:
          domain: climate

    aqara_trv_select_entity:
      name: TRV Sensor Mode Selector
      description: Select entity for TRV sensor source (internal / external).
      selector:
        entity:
          domain: select

    aqara_trv_number_entity:
      name: TRV External Temperature Number
      description: Number entity used to update the TRVâ€™s internal value with the external reading.
      selector:
        entity:
          domain: number

    external_sensor:
      name: External Temperature Sensor
      description: Aqara temperature & humidity sensor used as external reference.
      selector:
        entity:
          domain: sensor
          device_class: temperature

    comfort_schedules:
      name: Comfort Schedules
      description: >
        Select one or more Home Assistant Schedule helpers defining Comfort periods.
        When any selected schedule is ON, Comfort mode becomes active.
        These helpers automatically handle midnight rollovers.
      selector:
        entity:
          domain: schedule
          multiple: true

    eco_schedules:
      name: Eco Schedules (optional)
      description: >
        Optionally select one or more Home Assistant Schedule helpers defining Eco periods.
        If no Comfort schedule is ON and any Eco schedule is ON, Eco mode becomes active.
        If none are ON, the system defaults to Eco.
      default: [ ]
      selector:
        entity:
          domain: schedule
          multiple: true

    comfort_temperature:
      name: Comfort Temperature
      description: Desired temperature during Comfort periods (15â€“30 Â°C, decimals allowed).
      selector:
        number:
          min: 15
          max: 30
          step: 0.5
          mode: box

    eco_temperature:
      name: Eco Temperature
      description: Desired temperature during Eco periods (15â€“30 Â°C, decimals allowed).
      selector:
        number:
          min: 15
          max: 30
          step: 0.5
          mode: box

    stop_margin:
      name: Stop Margin (Heating Off Threshold)
      description: >
        Defines how close the room temperature must get to the target
        before the radiator valve turns **off**.
        Example: if target = 24 Â°C and Stop Margin = 0.2 Â°C,
        heating stops at **23.8 Â°C or higher** to prevent overheating from inertia.
      selector:
        number:
          min: 0.1
          max: 1.0
          step: 0.1
          mode: box
      default: 0.2

    start_margin:
      name: Restart Margin (Heating On Threshold)
      description: >
        Defines how much the room temperature must drop **below target**
        before the radiator valve turns **on** again.
        Example: if target = 24 Â°C and Restart Margin = 0.5 Â°C,
        heating starts at **23.5 Â°C or lower** to reduce frequent cycling.
      selector:
        number:
          min: 0.1
          max: 1.0
          step: 0.1
          mode: box
      default: 0.5

mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input external_sensor
  - platform: homeassistant
    event: start
  - platform: state
    entity_id: !input comfort_schedules
  - platform: state
    entity_id: !input eco_schedules
  - platform: event
    event_type: automation_reloaded
  - platform: event
    event_type: automation_config_changed

variables:
  aqara_trv: !input aqara_trv
  aqara_trv_select_entity: !input aqara_trv_select_entity
  aqara_trv_number_entity: !input aqara_trv_number_entity
  external_sensor: !input external_sensor
  comfort_schedules: !input comfort_schedules
  eco_schedules: !input eco_schedules
  comfort_temperature: !input comfort_temperature
  eco_temperature: !input eco_temperature
  stop_margin: !input stop_margin
  start_margin: !input start_margin

  external_temp: >
    {% set val = states(external_sensor) %}
    {% if val not in ['unavailable','unknown','undefined','none',''] %}
      {{ val | float }}
    {% else %}
      none
    {% endif %}

  active_mode: >
    {% set comfort_on = expand(comfort_schedules) | selectattr('state','eq','on') | list %}
    {% set eco_on = expand(eco_schedules) | selectattr('state','eq','on') | list %}
    {% if (comfort_on | count) > 0 %}
      comfort
    {% elif (eco_on | count) > 0 %}
      eco
    {% else %}
      eco
    {% endif %}

  target_temp: >
    {% if active_mode == 'comfort' %}
      {{ comfort_temperature | float }}
    {% else %}
      {{ eco_temperature | float }}
    {% endif %}

  is_schedule_trigger: >
    {% set tid = trigger.entity_id if trigger is defined and trigger.entity_id is defined else '' %}
    {{ tid.startswith('schedule.') }}

condition: [ ]

action:
  - choose:
      - conditions: >
          {{ external_temp == 'none' or not (external_temp is number) }}
        sequence:
          - choose:
              - conditions: >
                  {{ states[aqara_trv_select_entity].state != 'internal' }}
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: !input aqara_trv_select_entity
                    data:
                      option: internal
          - service: system_log.write
            data:
              level: error
              message: "External temperature sensor unavailable â€” switched TRV to internal."
          - stop: "External sensor unavailable."

  - choose:
      - conditions: >
          {{ external_temp < 15 or external_temp > 35 }}
        sequence:
          - service: system_log.write
            data:
              level: warning
              message: "External temperature {{ external_temp }} Â°C out of safe range (15â€“35) â€” ignored."
          - stop: "External temperature outside safe range."

  - choose:
      - conditions: >
          {{ (not is_schedule_trigger) and (((states[aqara_trv_number_entity].state | float(999)) - external_temp) | abs < 0.05) }}
        sequence:
          - stop: "No significant external temperature change (Î” < 0.05 Â°C)."

  - service: system_log.write
    data:
      level: info
      message: >
        "TRV check â†’ mode: {{ active_mode }}, target: {{ target_temp }}, external: {{ external_temp }}, time: {{ now().strftime('%H:%M') }}"

  - choose:
      - conditions: >
          {{ states[aqara_trv] in ['unavailable','unknown','none'] }}
        sequence:
          - service: system_log.write
            data:
              level: error
              message: "TRV unavailable â€” skipping actions."
          - stop: "TRV unavailable."

  - choose:
      - conditions: >
          {% set comfort_on = expand(comfort_schedules) | selectattr('state','eq','on') | list %}
          {% set eco_on = expand(eco_schedules) | selectattr('state','eq','on') | list %}
          {{ (comfort_on | count) > 0 and (eco_on | count) > 0 }}
        sequence:
          - service: system_log.write
            data:
              level: warning
              message: "Both Comfort and Eco schedules ON â€” prioritizing Comfort."

  - choose:
      - conditions: >
          {{ states[aqara_trv_select_entity].state != 'external' }}
        sequence:
          - service: select.select_option
            target:
              entity_id: !input aqara_trv_select_entity
            data:
              option: external

  - choose:
      - conditions: >
          {{ (((states[aqara_trv_number_entity].state | float(999)) - external_temp) | abs) >= 0.1 }}
        sequence:
          - service: number.set_value
            target:
              entity_id: !input aqara_trv_number_entity
            data:
              value: "{{ external_temp | float }}"

  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ external_temp is number and external_temp >= (target_temp - stop_margin) }}
        sequence:
          - choose:
              - conditions: >
                  {{ states[aqara_trv].state != 'off' }}
                sequence:
                  - service: climate.set_hvac_mode
                    target: { entity_id: "{{ aqara_trv }}" }
                    data: { hvac_mode: "off" }
                  - service: system_log.write
                    data:
                      level: info
                      message: "Heating OFF (temp â‰¥ target âˆ’ {{ stop_margin }})."

      - conditions:
          - condition: template
            value_template: >
              {{ external_temp is number and external_temp <= (target_temp - start_margin) }}
        sequence:
          - choose:
              - conditions: >
                  {{ states[aqara_trv].state != 'heat' }}
                sequence:
                  - service: climate.set_hvac_mode
                    target: { entity_id: "{{ aqara_trv }}" }
                    data: { hvac_mode: "heat" }
                  - service: system_log.write
                    data:
                      level: info
                      message: "Heating ON (temp â‰¤ target âˆ’ {{ start_margin }})."
          - choose:
              - conditions: >
                  {{ (state_attr(aqara_trv, 'temperature') | float(0)) != target_temp }}
                sequence:
                  - service: climate.set_temperature
                    target: { entity_id: "{{ aqara_trv }}" }
                    data: { temperature: "{{ target_temp | float }}" }

  - stop: Stable temperature zone â€” no action required.
