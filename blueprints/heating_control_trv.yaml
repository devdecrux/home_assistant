blueprint:
  name: Aqara TRV â€“ External Sensor (Comfort/Eco with Schedule & Smart Heating v9)
  description: >
    Controls an Aqara TRV E1 using an external Aqara temperature sensor.

    ðŸ”§ Features:
      â€¢ Updates TRV internal reading using number.set_value (same logic as pavax blueprint)  
      â€¢ Automatic switch between internal/external sensor modes  
      â€¢ Comfort / Eco temperature modes based on robust scheduling  
      â€¢ Handles midnight-crossing ranges and previous-day safety  
      â€¢ Configurable hysteresis margins for heating control  
      â€¢ Ignores minor sensor noise and unrealistic readings  
      â€¢ Skips redundant commands to reduce Zigbee load  
      â€¢ Smart logging and startup re-synchronization  
      â€¢ Uses TRV modes heat/off only

  domain: automation

  input:
    aqara_trv:
      name: Aqara TRV
      description: The TRV climate entity to control.
      selector:
        entity:
          domain: climate

    aqara_trv_select_entity:
      name: TRV Sensor Mode Selector
      description: Select entity for TRV sensor source (internal/external).
      selector:
        entity:
          domain: select

    aqara_trv_number_entity:
      name: TRV External Temperature Number
      description: Number entity used to update TRV's internal value with external reading.
      selector:
        entity:
          domain: number

    external_sensor:
      name: External Temperature Sensor
      description: Aqara temperature & humidity sensor used for external reading.
      selector:
        entity:
          domain: sensor
          device_class: temperature

    comfort_temperature:
      name: Comfort Temperature
      description: Desired temperature during comfort periods (15â€“30 Â°C, decimals allowed).
      selector:
        number:
          min: 15
          max: 30
          step: 0.5
          mode: box

    eco_temperature:
      name: Eco Temperature
      description: Desired temperature during eco periods (15â€“30 Â°C, decimals allowed).
      selector:
        number:
          min: 15
          max: 30
          step: 0.5
          mode: box

    stop_margin:
      name: Stop Margin (Heating Off Threshold)
      description: >
        Defines how close the room temperature must get to the target
        before the radiator valve turns **off**.  
        Example: if the target is 24 Â°C and Stop Margin = 0.2 Â°C,
        heating stops at **23.8 Â°C or higher**.
        Helps prevent overheating from radiator inertia.
      selector:
        number:
          min: 0.1
          max: 1.0
          step: 0.1
          mode: box
      default: 0.1

    start_margin:
      name: Restart Margin (Heating On Threshold)
      description: >
        Defines how much the room temperature must drop **below the target**
        before the radiator valve turns **on** again.  
        Example: if the target is 24 Â°C and Restart Margin = 0.5 Â°C,
        heating starts at **23.5 Â°C or lower**.
        A higher value reduces frequent on/off switching.
      selector:
        number:
          min: 0.1
          max: 1.0
          step: 0.1
          mode: box
      default: 0.5

    schedules:
      name: Weekly Schedule
      description: >
        Define time-based mode switches between Comfort and Eco.
        Example:
          - days: [mon,tue,wed,thu,fri]
            start: "07:00"
            end: "09:00"
            mode: "comfort"
          - days: [mon,tue,wed,thu,fri]
            start: "22:00"
            end: "07:00"
            mode: "eco"
      selector:
        object:

mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input external_sensor
  - platform: homeassistant
    event: start

variables:
  aqara_trv: !input aqara_trv
  aqara_trv_select_entity: !input aqara_trv_select_entity
  aqara_trv_number_entity: !input aqara_trv_number_entity
  external_sensor: !input external_sensor
  comfort_temperature: !input comfort_temperature
  eco_temperature: !input eco_temperature
  schedules: !input schedules
  stop_margin: !input stop_margin
  start_margin: !input start_margin

  external_temp: >
    {% set val = states(external_sensor) %}
    {% if val not in ['unavailable','unknown','undefined','none',''] %}
      {{ val | float }}
    {% else %}
      none
    {% endif %}

  active_mode: >
    {% set now_local = now() %}
    {% set now_day = now_local.strftime('%a') | lower %}
    {% set yesterday_day = (now_local - timedelta(days=1)).strftime('%a') | lower %}
    {% set now_minutes = now_local.hour * 60 + now_local.minute %}
    {% set ns = namespace(mode='eco') %}
    {% if schedules is defined and schedules %}
      {% for s in schedules %}
        {% set days = s.days if s.days is defined else [] %}
        {% set start = s.start if s.start is defined else '00:00' %}
        {% set end = s.end if s.end is defined else '23:59' %}
        {% set mode = s.mode if s.mode is defined else 'eco' %}
        {% set sh, sm = start.split(':') %}
        {% set eh, em = end.split(':') %}
        {% set start_m = (sh | int)*60 + (sm | int) %}
        {% set end_m = (eh | int)*60 + (em | int) %}
        {% set crosses_midnight = start_m > end_m %}
        {% set valid_day = (now_day in days) or ('all' in days)
            or (crosses_midnight and (yesterday_day in days) and (now_minutes < end_m)) %}
        {% if valid_day %}
          {% if (not crosses_midnight and start_m <= now_minutes < end_m)
                or (crosses_midnight and (now_minutes >= start_m or now_minutes < end_m)) %}
            {% set ns.mode = mode %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {{ ns.mode }}

  target_temp: >
    {% if active_mode == 'comfort' %}
      {{ comfort_temperature | float }}
    {% else %}
      {{ eco_temperature | float }}
    {% endif %}

condition: [ ]

action:
  # --- Skip if external temp invalid or unchanged (<0.05 Â°C delta) ---
  - choose:
      - conditions: >
          {{ external_temp == 'none' or not (external_temp is number)
             or abs((states[aqara_trv_number_entity].state | float(999)) - external_temp) < 0.05 }}
        sequence:
          - stop: "No significant or valid external temperature change."

  # --- Clamp sanity range 15â€“35 Â°C ---
  - choose:
      - conditions: >
          {{ external_temp < 15 or external_temp > 35 }}
        sequence:
          - service: system_log.write
            data:
              level: warning
              message: "External temperature {{ external_temp }} Â°C out of safe range (15â€“35) â€” ignoring update."
          - stop: "External temperature outside safe range."

  # --- Debug log ---
  - service: system_log.write
    data:
      level: info
      message: >
        "TRV check â†’ mode: {{ active_mode }}, target: {{ target_temp }}, external: {{ external_temp }}, time: {{ now().strftime('%H:%M') }}"

  # --- Skip if TRV unavailable ---
  - choose:
      - conditions: >
          {{ states[aqara_trv] in ['unavailable','unknown','none'] }}
        sequence:
          - service: system_log.write
            data:
              level: error
              message: "TRV unavailable â€” skipping actions."
          - stop: "TRV unavailable."

  # --- External sensor unavailable ---
  - choose:
      - conditions: >
          {{ external_temp == 'none' or not (external_temp is number) }}
        sequence:
          - service: select.select_option
            target:
              entity_id: !input aqara_trv_select_entity
            data:
              option: internal
          - service: system_log.write
            data:
              level: error
              message: "External temperature sensor unavailable â€” switched TRV to internal."
          - stop: "External sensor unavailable."

  # --- External sensor available, ensure TRV external mode ---
  - choose:
      - conditions: >
          {{ states[aqara_trv_select_entity].state != 'external' }}
        sequence:
          - service: select.select_option
            target:
              entity_id: !input aqara_trv_select_entity
            data:
              option: external

  # --- Update TRV temperature only if significant change (â‰¥0.1 Â°C) ---
  - choose:
      - conditions: >
          {{ abs((states[aqara_trv_number_entity].state | float(999)) - external_temp) >= 0.1 }}
        sequence:
          - service: number.set_value
            target:
              entity_id: !input aqara_trv_number_entity
            data:
              value: "{{ external_temp | float }}"

  # --- Heating logic with configurable hysteresis ---
  - choose:
      # Stop heating (>= target âˆ’ stop_margin)
      - conditions:
          - condition: template
            value_template: >
              {{ external_temp is number and external_temp >= (target_temp - stop_margin) }}
        sequence:
          - choose:
              - conditions: >
                  {{ states[aqara_trv].state != 'off' }}
                sequence:
                  - service: climate.set_hvac_mode
                    target: { entity_id: "{{ aqara_trv }}" }
                    data: { hvac_mode: "off" }
                  - service: system_log.write
                    data:
                      level: info
                      message: "Heating OFF (temp â‰¥ target âˆ’ {{ stop_margin }})."

      # Start heating (â‰¤ target âˆ’ start_margin)
      - conditions:
          - condition: template
            value_template: >
              {{ external_temp is number and external_temp <= (target_temp - start_margin) }}
        sequence:
          - choose:
              - conditions: >
                  {{ states[aqara_trv].state != 'heat' }}
                sequence:
                  - service: climate.set_hvac_mode
                    target: { entity_id: "{{ aqara_trv }}" }
                    data: { hvac_mode: "heat" }
                  - service: system_log.write
                    data:
                      level: info
                      message: "Heating ON (temp â‰¤ target âˆ’ {{ start_margin }})."
          - choose:
              - conditions: >
                  {{ (state_attr(aqara_trv, 'temperature') | float(0)) != target_temp }}
                sequence:
                  - service: climate.set_temperature
                    target: { entity_id: "{{ aqara_trv }}" }
                    data: { temperature: "{{ target_temp | float }}" }

  - stop: Stable temperature zone â€” no action required.
