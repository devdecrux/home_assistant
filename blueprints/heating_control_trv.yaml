blueprint:
  name: Aqara TRV – External Sensor (Comfort Mode, Auto-Fallback)
  description: >
    Controls an Aqara TRV using an external temperature sensor for comfort heating.

    Features:
    - Uses an external temperature sensor for accurate room temperature control.
    - Falls back to TRV internal sensor if external becomes unavailable.
    - Turns off heating slightly before reaching comfort temperature (radiator offset).
    - Always updates TRV temperature, even when heating turns off.
    - Comfort temperature entered manually (numeric input field).
    - Automation runs in "restart" mode to always act on the latest readings.

  domain: automation
  input:
    trv_entity:
      name: Aqara TRV
      description: Select your TRV climate entity.
      selector:
        entity:
          domain: climate

    external_temp_sensor:
      name: External temperature sensor
      description: Select your external room temperature sensor.
      selector:
        entity:
          domain: sensor
          device_class: temperature

    last_temp_helper:
      name: Helper for last external temperature
      description: Select an input_number helper to store the last valid external temperature reading.
      selector:
        entity:
          domain: input_number

    comfort_temperature:
      name: Comfort temperature
      description: Enter your desired comfort temperature between 10 °C and 30 °C.
      default: "22"
      selector:
        text:
          type: number

variables:
  trv_entity: !input trv_entity
  external_temp_sensor: !input external_temp_sensor
  last_temp_helper: !input last_temp_helper
  comfort_temperature: !input comfort_temperature
  tolerance: 0.4
  radiator_offset: 0.3

trigger:
  - platform: state
    entity_id: !input external_temp_sensor
  - platform: state
    entity_id: !input external_temp_sensor
    to:
      - "unavailable"
      - "unknown"
      - "undefined"
  - platform: homeassistant
    event: start
  - platform: event
    event_type: automation_reloaded

condition: [ ]

action:
  - variables:
      sensor_state_raw: "{{ states(external_temp_sensor) }}"
      external_temp_value: >
        {% if sensor_state_raw in ['unavailable','unknown','undefined',None,'none','None'] %}
          none
        {% else %}
          {{ states(external_temp_sensor) | float }}
        {% endif %}
      last_external_temp_value: "{{ states(last_temp_helper) | float(0) }}"
      trv_internal_temp: "{{ state_attr(trv_entity, 'current_temperature') | float(0) }}"
      comfort_temp_value: "{{ comfort_temperature | float }}"

  # Ensure comfort temperature is within valid range
  - condition: template
    value_template: >
      {{ 10 <= comfort_temp_value <= 30 }}

  # Fallback: external sensor unavailable → use TRV internal reading
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ sensor_state_raw in ['unavailable','unknown','undefined',None,'none','None'] }}
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: "{{ trv_entity }}"
            data:
              temperature: "{{ comfort_temp_value }}"
          - service: climate.set_hvac_mode
            target:
              entity_id: "{{ trv_entity }}"
            data:
              hvac_mode: "heat"
          - service: input_number.set_value
            target:
              entity_id: "{{ last_temp_helper }}"
            data:
              value: "{{ trv_internal_temp }}"
          - stop: "External sensor unavailable — fallback to internal TRV temperature."

  - variables:
      external_temp: "{{ external_temp_value | float }}"

  # Ignore small changes (less than tolerance)
  - condition: template
    value_template: >
      {{ (external_temp - last_external_temp_value) | abs >= tolerance }}

  # Update stored last temperature
  - service: input_number.set_value
    target:
      entity_id: "{{ last_temp_helper }}"
    data:
      value: "{{ external_temp }}"

  # Main heating control
  - choose:
      # Heating ON: external temp below comfort - offset
      - conditions:
          - condition: template
            value_template: >
              {{ external_temp < (comfort_temp_value - radiator_offset) }}
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: "{{ trv_entity }}"
            data:
              hvac_mode: "heat"
          - service: climate.set_temperature
            target:
              entity_id: "{{ trv_entity }}"
            data:
              temperature: "{{ comfort_temp_value }}"
      # Heating OFF: temperature reached or exceeded
      - conditions:
          - condition: template
            value_template: >
              {{ external_temp >= (comfort_temp_value - radiator_offset) }}
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: "{{ trv_entity }}"
            data:
              temperature: "{{ external_temp }}"
          - service: climate.set_hvac_mode
            target:
              entity_id: "{{ trv_entity }}"
            data:
              hvac_mode: "off"

mode: restart
